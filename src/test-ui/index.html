<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Essay Agent Test</title>

  <style>
    body {
      background: #0f172a;
      color: #e5e7eb;
      font-family: system-ui, sans-serif;
      display: flex;
      justify-content: center;
      padding: 24px;
    }
    .container {
      width: 100%;
      max-width: 900px;
      display: grid;
      gap: 20px;
    }
    .card {
      background: #020617;
      border-radius: 14px;
      padding: 20px;
      border: 1px solid #1f2937;
    }
    h1 {
      text-align: center;
      color: #c7d2fe;
    }
    h2 {
      margin-top: 0;
      color: #c7d2fe;
      font-size: 1.1rem;
    }
    textarea, input[type="file"], button {
      width: 100%;
      border-radius: 10px;
      padding: 12px;
      font-size: 14px;
    }
    textarea, input[type="file"] {
      background: #020617;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }
    button {
      background: #6366f1;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }
    button.secondary {
      background: #334155;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    pre {
      background: #020617;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid #1f2937;
      white-space: pre-wrap;
      max-height: 400px;
      overflow: auto;
      font-size: 0.9rem;
    }
  </style>
</head>

<body>
<div class="container">

  <h1>Essay Agent Test</h1>

  <!-- LIVE VOICE -->
  <div class="card">
    <h2>üéô Live Voice ‚Üí Essay</h2>
    <button id="startBtn">Start Talking</button>
    <button id="stopBtn" class="secondary" disabled>
      Stop & Generate Essay
    </button>
  </div>

  <!-- PROMPT -->
  <div class="card">
    <h2>‚úç Prompt ‚Üí Essay</h2>
    <textarea
      id="prompt"
      placeholder="Write a 300 word scholarship essay about my academic goals"
    ></textarea>
    <button onclick="sendPrompt()">Generate Essay</button>
  </div>

  <!-- DOCUMENT -->
  <div class="card">
    <h2>üìÑ Document / Text ‚Üí Essay</h2>
    <input type="file" id="doc" accept=".pdf,.txt,.docx" />
    <button onclick="sendDoc()">Upload Document</button>
  </div>

  <!-- OUTPUT -->
  <div class="card">
    <h2>üì§ Output</h2>
    <pre id="output">Waiting...</pre>
  </div>

</div>

<script>
/* ================== LIVE WAV RECORDER ================== */

let audioContext;
let processor;
let input;
let stream;
let audioData = [];

const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const output = document.getElementById("output");

startBtn.onclick = async () => {
  audioData = [];
  stream = await navigator.mediaDevices.getUserMedia({ audio: true });

  audioContext = new AudioContext();
  input = audioContext.createMediaStreamSource(stream);
  processor = audioContext.createScriptProcessor(4096, 1, 1);

  processor.onaudioprocess = e => {
    audioData.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };

  input.connect(processor);
  processor.connect(audioContext.destination);

  startBtn.disabled = true;
  stopBtn.disabled = false;
};

stopBtn.onclick = async () => {
  processor.disconnect();
  input.disconnect();
  stream.getTracks().forEach(t => t.stop());

  const wavBlob = encodeWAV(audioData, audioContext.sampleRate);
  const file = new File([wavBlob], "voice.wav", { type: "audio/wav" });

  const form = new FormData();
  form.append("audio", file);

  output.textContent = "Processing voice...";

  const res = await fetch("/api/essay", {
    method: "POST",
    body: form
  });

  const text = await res.text();
  try {
    output.textContent = JSON.stringify(JSON.parse(text), null, 2);
  } catch {
    output.textContent = text;
  }

  startBtn.disabled = false;
  stopBtn.disabled = true;
};

/* ================== WAV ENCODER ================== */

function encodeWAV(buffers, sampleRate) {
  let length = buffers.reduce((a, b) => a + b.length, 0);
  let pcm = new Float32Array(length);
  let offset = 0;

  buffers.forEach(b => {
    pcm.set(b, offset);
    offset += b.length;
  });

  const buffer = new ArrayBuffer(44 + pcm.length * 2);
  const view = new DataView(buffer);

  writeString(view, 0, "RIFF");
  view.setUint32(4, 36 + pcm.length * 2, true);
  writeString(view, 8, "WAVE");
  writeString(view, 12, "fmt ");
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(view, 36, "data");
  view.setUint32(40, pcm.length * 2, true);

  let index = 44;
  pcm.forEach(s => {
    view.setInt16(index, Math.max(-1, Math.min(1, s)) * 0x7fff, true);
    index += 2;
  });

  return new Blob([view], { type: "audio/wav" });
}

function writeString(view, offset, str) {
  for (let i = 0; i < str.length; i++) {
    view.setUint8(offset + i, str.charCodeAt(i));
  }
}

/* ================== PROMPT ================== */

async function sendPrompt() {
  const prompt = document.getElementById("prompt").value;

  const res = await fetch("/api/essay", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const text = await res.text();
  try {
    output.textContent = JSON.stringify(JSON.parse(text), null, 2);
  } catch {
    output.textContent = text;
  }
}

/* ================== DOCUMENT ================== */

async function sendDoc() {
  const file = document.getElementById("doc").files[0];
  if (!file) return alert("Please select a document");

  const form = new FormData();
  form.append("file", file);

  output.textContent = "Processing document...";

  const res = await fetch("/api/essay", {
    method: "POST",
    body: form
  });

  const text = await res.text();
  try {
    output.textContent = JSON.stringify(JSON.parse(text), null, 2);
  } catch {
    output.textContent = text;
  }
}
</script>

</body>
</html>
